using System;
using System.Collections.Generic;
using Helpers;
using TaleWorlds.CampaignSystem.Actions;
using TaleWorlds.Localization;
using TaleWorlds.ObjectSystem;
using TaleWorlds.SaveSystem;

namespace TaleWorlds.CampaignSystem.LogEntries
{
	// Token: 0x020002E5 RID: 741
	public class EndCaptivityLogEntry : LogEntry, IEncyclopediaLog, IChatNotification
	{
		// Token: 0x06002B5F RID: 11103 RVA: 0x000B7D77 File Offset: 0x000B5F77
		internal static void AutoGeneratedStaticCollectObjectsEndCaptivityLogEntry(object o, List<object> collectedObjects)
		{
			((EndCaptivityLogEntry)o).AutoGeneratedInstanceCollectObjects(collectedObjects);
		}

		// Token: 0x06002B60 RID: 11104 RVA: 0x000B7D85 File Offset: 0x000B5F85
		protected override void AutoGeneratedInstanceCollectObjects(List<object> collectedObjects)
		{
			base.AutoGeneratedInstanceCollectObjects(collectedObjects);
			collectedObjects.Add(this.CapturerMapFaction);
			collectedObjects.Add(this.Prisoner);
		}

		// Token: 0x06002B61 RID: 11105 RVA: 0x000B7DA6 File Offset: 0x000B5FA6
		internal static object AutoGeneratedGetMemberValueDetail(object o)
		{
			return ((EndCaptivityLogEntry)o).Detail;
		}

		// Token: 0x06002B62 RID: 11106 RVA: 0x000B7DB8 File Offset: 0x000B5FB8
		internal static object AutoGeneratedGetMemberValueCapturerMapFaction(object o)
		{
			return ((EndCaptivityLogEntry)o).CapturerMapFaction;
		}

		// Token: 0x06002B63 RID: 11107 RVA: 0x000B7DC5 File Offset: 0x000B5FC5
		internal static object AutoGeneratedGetMemberValuePrisoner(object o)
		{
			return ((EndCaptivityLogEntry)o).Prisoner;
		}

		// Token: 0x17000AA8 RID: 2728
		// (get) Token: 0x06002B64 RID: 11108 RVA: 0x000B7DD2 File Offset: 0x000B5FD2
		// (set) Token: 0x06002B65 RID: 11109 RVA: 0x000B7DDA File Offset: 0x000B5FDA
		[SaveableProperty(732)]
		public EndCaptivityDetail Detail { get; private set; }

		// Token: 0x06002B66 RID: 11110 RVA: 0x000B7DE3 File Offset: 0x000B5FE3
		public EndCaptivityLogEntry(Hero prisoner, IFaction capturerMapFaction, EndCaptivityDetail detail)
		{
			this.CapturerMapFaction = capturerMapFaction;
			this.Prisoner = prisoner;
			this.Detail = detail;
		}

		// Token: 0x06002B67 RID: 11111 RVA: 0x000B7E00 File Offset: 0x000B6000
		public override string ToString()
		{
			return this.GetEncyclopediaText().ToString();
		}

		// Token: 0x17000AA9 RID: 2729
		// (get) Token: 0x06002B68 RID: 11112 RVA: 0x000B7E0D File Offset: 0x000B600D
		public bool IsVisibleNotification
		{
			get
			{
				return true;
			}
		}

		// Token: 0x06002B69 RID: 11113 RVA: 0x000B7E10 File Offset: 0x000B6010
		public TextObject GetEncyclopediaText()
		{
			return this.GetNotificationText();
		}

		// Token: 0x06002B6A RID: 11114 RVA: 0x000B7E18 File Offset: 0x000B6018
		public bool IsVisibleInEncyclopediaPageOf<T>(T obj) where T : MBObjectBase
		{
			return obj == this.Prisoner || obj == this.Prisoner.Clan;
		}

		// Token: 0x17000AAA RID: 2730
		// (get) Token: 0x06002B6B RID: 11115 RVA: 0x000B7E3D File Offset: 0x000B603D
		public override ChatNotificationType NotificationType
		{
			get
			{
				return base.MilitaryNotification(this.Prisoner.Clan, null);
			}
		}

		// Token: 0x06002B6C RID: 11116 RVA: 0x000B7E54 File Offset: 0x000B6054
		public TextObject GetNotificationText()
		{
			TextObject textObject = new TextObject("{=6u3t174w}{PRISONER_LORD.LINK}{?PRISONER_LORD_HAS_FACTION_LINK} of the {PRISONER_LORD_FACTION_LINK}{?}{\\?} is now free.", null);
			switch (this.Detail)
			{
			case EndCaptivityDetail.Ransom:
				textObject = new TextObject("{=pX0MgdZA}{PRISONER_LORD.LINK}{?PRISONER_LORD_HAS_FACTION_LINK} of the {PRISONER_LORD_FACTION_LINK}{?}{\\?} has been ransomed from the {CAPTURER_FACTION}.", null);
				break;
			case EndCaptivityDetail.ReleasedAfterPeace:
				textObject = new TextObject("{=wlhJGG0q}{PRISONER_LORD.LINK}{?PRISONER_LORD_HAS_FACTION_LINK} of the {PRISONER_LORD_FACTION_LINK}{?}{\\?} has been freed because of a peace declaration.", null);
				break;
			case EndCaptivityDetail.ReleasedAfterBattle:
				textObject = new TextObject("{=hp4jLl3M}{PRISONER_LORD.LINK}{?PRISONER_LORD_HAS_FACTION_LINK} of the {PRISONER_LORD_FACTION_LINK}{?}{\\?} has been released after battle.", null);
				break;
			case EndCaptivityDetail.ReleasedAfterEscape:
				textObject = new TextObject("{=krTrNonp}{PRISONER_LORD.LINK}{?PRISONER_LORD_HAS_FACTION_LINK} of the {PRISONER_LORD_FACTION_LINK}{?}{\\?} has escaped from captivity.", null);
				break;
			case EndCaptivityDetail.Death:
				textObject = new TextObject("{=XbQFAKUz}{PRISONER_LORD.LINK}{?PRISONER_LORD_HAS_FACTION_LINK} of the {PRISONER_LORD_FACTION_LINK}{?}{\\?} has died while being held captive by the {CAPTURER_FACTION}.", null);
				break;
			case EndCaptivityDetail.ReleasedByCompensation:
				textObject = new TextObject("{=krTrNonp}{PRISONER_LORD.LINK}{?PRISONER_LORD_HAS_FACTION_LINK} of the {PRISONER_LORD_FACTION_LINK}{?}{\\?} has escaped from captivity.", null);
				break;
			}
			Clan clan = this.Prisoner.Clan;
			if (clan != null && !clan.IsMinorFaction)
			{
				textObject.SetTextVariable("PRISONER_LORD_FACTION_LINK", this.Prisoner.MapFaction.EncyclopediaLinkWithName);
				textObject.SetTextVariable("PRISONER_LORD_HAS_FACTION_LINK", 1);
			}
			StringHelpers.SetCharacterProperties("PRISONER_LORD", this.Prisoner.CharacterObject, textObject, false);
			if (this.CapturerMapFaction != null)
			{
				textObject.SetTextVariable("CAPTURER_FACTION", this.CapturerMapFaction.InformalName);
			}
			return textObject;
		}

		// Token: 0x06002B6D RID: 11117 RVA: 0x000B7F67 File Offset: 0x000B6167
		public override void GetConversationScoreAndComment(Hero talkTroop, bool findString, out string comment, out ImportanceEnum score)
		{
			score = ImportanceEnum.Zero;
			comment = "";
			if (talkTroop == this.Prisoner && talkTroop.IsPlayerCompanion)
			{
				if (this.Detail == EndCaptivityDetail.Ransom)
				{
					score = ImportanceEnum.VeryImportant;
					comment = "str_comment_captivity_release_companion_ransom";
					return;
				}
				score = ImportanceEnum.VeryImportant;
				comment = "str_comment_captivity_release_companion";
			}
		}

		// Token: 0x04000D01 RID: 3329
		[SaveableField(730)]
		public readonly IFaction CapturerMapFaction;

		// Token: 0x04000D02 RID: 3330
		[SaveableField(731)]
		public readonly Hero Prisoner;
	}
}
