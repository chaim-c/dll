using System;
using System.Collections.Generic;
using Helpers;
using TaleWorlds.CampaignSystem.Settlements;
using TaleWorlds.Library;
using TaleWorlds.Localization;
using TaleWorlds.ObjectSystem;
using TaleWorlds.SaveSystem;

namespace TaleWorlds.CampaignSystem.LogEntries
{
	// Token: 0x020002E6 RID: 742
	public class TournamentWonLogEntry : LogEntry, IEncyclopediaLog, IChatNotification
	{
		// Token: 0x06002B6E RID: 11118 RVA: 0x000B7FA4 File Offset: 0x000B61A4
		internal static void AutoGeneratedStaticCollectObjectsTournamentWonLogEntry(object o, List<object> collectedObjects)
		{
			((TournamentWonLogEntry)o).AutoGeneratedInstanceCollectObjects(collectedObjects);
		}

		// Token: 0x06002B6F RID: 11119 RVA: 0x000B7FB2 File Offset: 0x000B61B2
		protected override void AutoGeneratedInstanceCollectObjects(List<object> collectedObjects)
		{
			base.AutoGeneratedInstanceCollectObjects(collectedObjects);
			collectedObjects.Add(this._participants);
			collectedObjects.Add(this.Winner);
			collectedObjects.Add(this.Town);
		}

		// Token: 0x06002B70 RID: 11120 RVA: 0x000B7FDF File Offset: 0x000B61DF
		internal static object AutoGeneratedGetMemberValueWinner(object o)
		{
			return ((TournamentWonLogEntry)o).Winner;
		}

		// Token: 0x06002B71 RID: 11121 RVA: 0x000B7FEC File Offset: 0x000B61EC
		internal static object AutoGeneratedGetMemberValueTown(object o)
		{
			return ((TournamentWonLogEntry)o).Town;
		}

		// Token: 0x06002B72 RID: 11122 RVA: 0x000B7FF9 File Offset: 0x000B61F9
		internal static object AutoGeneratedGetMemberValue_participants(object o)
		{
			return ((TournamentWonLogEntry)o)._participants;
		}

		// Token: 0x17000AAB RID: 2731
		// (get) Token: 0x06002B73 RID: 11123 RVA: 0x000B8006 File Offset: 0x000B6206
		// (set) Token: 0x06002B74 RID: 11124 RVA: 0x000B800E File Offset: 0x000B620E
		[SaveableProperty(931)]
		public Hero Winner { get; private set; }

		// Token: 0x17000AAC RID: 2732
		// (get) Token: 0x06002B75 RID: 11125 RVA: 0x000B8017 File Offset: 0x000B6217
		// (set) Token: 0x06002B76 RID: 11126 RVA: 0x000B801F File Offset: 0x000B621F
		[SaveableProperty(932)]
		public Town Town { get; private set; }

		// Token: 0x17000AAD RID: 2733
		// (get) Token: 0x06002B77 RID: 11127 RVA: 0x000B8028 File Offset: 0x000B6228
		public bool IsVisibleNotification
		{
			get
			{
				return true;
			}
		}

		// Token: 0x17000AAE RID: 2734
		// (get) Token: 0x06002B78 RID: 11128 RVA: 0x000B802B File Offset: 0x000B622B
		public override ChatNotificationType NotificationType
		{
			get
			{
				return base.CivilianNotification(this.Winner.Clan);
			}
		}

		// Token: 0x06002B79 RID: 11129 RVA: 0x000B8040 File Offset: 0x000B6240
		public TournamentWonLogEntry(Hero winner, Town town, MBReadOnlyList<CharacterObject> gameParticipants)
		{
			this.Winner = winner;
			this.Town = town;
			Dictionary<Hero, short> dictionary = new Dictionary<Hero, short>();
			foreach (CharacterObject characterObject in gameParticipants)
			{
				if (characterObject.HeroObject != null && !dictionary.ContainsKey(characterObject.HeroObject))
				{
					dictionary.Add(characterObject.HeroObject, 1);
				}
			}
			this._participants = dictionary.GetReadOnlyDictionary<Hero, short>();
		}

		// Token: 0x06002B7A RID: 11130 RVA: 0x000B80D0 File Offset: 0x000B62D0
		public override string ToString()
		{
			return "Tournament won";
		}

		// Token: 0x06002B7B RID: 11131 RVA: 0x000B80D7 File Offset: 0x000B62D7
		public TextObject GetEncyclopediaText()
		{
			return this.GetNotificationText();
		}

		// Token: 0x06002B7C RID: 11132 RVA: 0x000B80E0 File Offset: 0x000B62E0
		public TextObject GetNotificationText()
		{
			TextObject textObject = new TextObject("{=4ADQ7YZj}{PERSON.LINK} won the tournament at {TOWN}.", null);
			StringHelpers.SetCharacterProperties("PERSON", this.Winner.CharacterObject, textObject, false);
			textObject.SetTextVariable("TOWN", this.Town.Name);
			return textObject;
		}

		// Token: 0x06002B7D RID: 11133 RVA: 0x000B8129 File Offset: 0x000B6329
		public bool IsVisibleInEncyclopediaPageOf<T>(T obj) where T : MBObjectBase
		{
			return obj == this.Winner || obj == this.Winner.Clan || obj == this.Town.Settlement;
		}

		// Token: 0x06002B7E RID: 11134 RVA: 0x000B8164 File Offset: 0x000B6364
		public override void GetConversationScoreAndComment(Hero talkTroop, bool findString, out string comment, out ImportanceEnum score)
		{
			short num;
			if (!this._participants.TryGetValue(talkTroop, out num))
			{
				num = -2;
			}
			short num2;
			if (!this._participants.TryGetValue(Hero.MainHero, out num2))
			{
				num2 = -2;
			}
			score = ImportanceEnum.Zero;
			comment = "";
			if (num > 0 && num2 > 0)
			{
				score = ImportanceEnum.SomewhatImportant;
				if (findString)
				{
					MBTextManager.SetTextVariable("TOURNAMENT_TOWN", this.Town.Name, false);
					MBTextManager.SetTextVariable("TOURNAMENT_WINNER", this.Winner.Name, false);
					if (this.Winner == Hero.MainHero)
					{
						comment = "str_comment_you_won_tournament_elsewhere";
						if (this.Town.Settlement == Settlement.CurrentSettlement)
						{
							comment = "str_comment_you_won_tournament_here";
							return;
						}
					}
					else if (this.Winner == talkTroop)
					{
						comment = "str_comment_i_won_tournament_elsewhere";
						if (this.Town.Settlement == Settlement.CurrentSettlement)
						{
							comment = "str_comment_i_won_tournament_here";
							return;
						}
					}
					else
					{
						comment = "str_comment_someone_else_won_tournament_elsewhere";
						if (this.Town.Settlement == Settlement.CurrentSettlement)
						{
							comment = "str_comment_someone_else_won_tournament_here";
						}
					}
				}
			}
		}

		// Token: 0x04000D06 RID: 3334
		[SaveableField(934)]
		private MBReadOnlyDictionary<Hero, short> _participants;
	}
}
