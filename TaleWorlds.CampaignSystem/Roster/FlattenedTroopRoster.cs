using System;
using System.Collections;
using System.Collections.Generic;
using TaleWorlds.CampaignSystem.Party;
using TaleWorlds.Core;
using TaleWorlds.Library;
using TaleWorlds.SaveSystem;

namespace TaleWorlds.CampaignSystem.Roster
{
	// Token: 0x0200028B RID: 651
	public class FlattenedTroopRoster : IEnumerable<FlattenedTroopRosterElement>, IEnumerable
	{
		// Token: 0x0600235D RID: 9053 RVA: 0x000962FE File Offset: 0x000944FE
		internal static void AutoGeneratedStaticCollectObjectsFlattenedTroopRoster(object o, List<object> collectedObjects)
		{
			((FlattenedTroopRoster)o).AutoGeneratedInstanceCollectObjects(collectedObjects);
		}

		// Token: 0x0600235E RID: 9054 RVA: 0x0009630C File Offset: 0x0009450C
		protected virtual void AutoGeneratedInstanceCollectObjects(List<object> collectedObjects)
		{
			collectedObjects.Add(this._elementDictionary);
		}

		// Token: 0x0600235F RID: 9055 RVA: 0x0009631A File Offset: 0x0009451A
		internal static object AutoGeneratedGetMemberValue_elementDictionary(object o)
		{
			return ((FlattenedTroopRoster)o)._elementDictionary;
		}

		// Token: 0x06002360 RID: 9056 RVA: 0x00096327 File Offset: 0x00094527
		public FlattenedTroopRoster(int count = 4)
		{
			this._elementDictionary = new Dictionary<UniqueTroopDescriptor, FlattenedTroopRosterElement>(count);
		}

		// Token: 0x06002361 RID: 9057 RVA: 0x0009633B File Offset: 0x0009453B
		public FlattenedTroopRoster(TroopRoster roster) : this(roster.Count)
		{
			this.Add(roster.GetTroopRoster());
		}

		// Token: 0x06002362 RID: 9058 RVA: 0x00096355 File Offset: 0x00094555
		public FlattenedTroopRoster(FlattenedTroopRoster other)
		{
			this._elementDictionary = new Dictionary<UniqueTroopDescriptor, FlattenedTroopRosterElement>(other._elementDictionary);
		}

		// Token: 0x170008D2 RID: 2258
		public FlattenedTroopRosterElement this[UniqueTroopDescriptor index]
		{
			get
			{
				return this._elementDictionary[index];
			}
			set
			{
				this._elementDictionary[index] = value;
			}
		}

		// Token: 0x06002365 RID: 9061 RVA: 0x0009638C File Offset: 0x0009458C
		public void Add(MBList<TroopRosterElement> roster)
		{
			foreach (TroopRosterElement troopRosterElement in roster)
			{
				if (troopRosterElement.Number > 0)
				{
					int num = troopRosterElement.Xp / troopRosterElement.Number;
					int num2 = troopRosterElement.Xp % troopRosterElement.Number;
					for (int i = 0; i < troopRosterElement.Number; i++)
					{
						bool isWounded = i < troopRosterElement.WoundedNumber;
						int num3 = num;
						if (i < num2)
						{
							num3++;
						}
						this.Add(troopRosterElement.Character, isWounded, num3);
					}
				}
			}
		}

		// Token: 0x06002366 RID: 9062 RVA: 0x00096440 File Offset: 0x00094640
		public void Add(TroopRosterElement troop)
		{
			int num = troop.Xp / troop.Number;
			int num2 = troop.Xp % troop.Number;
			for (int i = 0; i < troop.Number; i++)
			{
				bool isWounded = i < troop.WoundedNumber;
				int num3 = num;
				if (i < num2)
				{
					num3++;
				}
				this.Add(troop.Character, isWounded, num3);
			}
		}

		// Token: 0x06002367 RID: 9063 RVA: 0x000964A8 File Offset: 0x000946A8
		public void Add(CharacterObject troop, int number, int woundedNumber = 0)
		{
			for (int i = 0; i < number; i++)
			{
				this.Add(troop, woundedNumber > 0, 0);
				woundedNumber--;
			}
		}

		// Token: 0x06002368 RID: 9064 RVA: 0x000964D4 File Offset: 0x000946D4
		public UniqueTroopDescriptor Add(CharacterObject troop, bool isWounded = false, int xp = 0)
		{
			FlattenedTroopRosterElement value = new FlattenedTroopRosterElement(troop, isWounded ? RosterTroopState.Wounded : RosterTroopState.Active, xp, default(UniqueTroopDescriptor), 0);
			this._elementDictionary.Add(value.Descriptor, value);
			return value.Descriptor;
		}

		// Token: 0x06002369 RID: 9065 RVA: 0x00096515 File Offset: 0x00094715
		public static int GenerateUniqueNoFromParty(MobileParty party, int troopIndex)
		{
			return (party.Party.Index * 999983 + troopIndex * 100003) % 616841;
		}

		// Token: 0x0600236A RID: 9066 RVA: 0x00096536 File Offset: 0x00094736
		public void Remove(UniqueTroopDescriptor descriptor)
		{
			this._elementDictionary.Remove(descriptor);
		}

		// Token: 0x170008D3 RID: 2259
		// (get) Token: 0x0600236B RID: 9067 RVA: 0x00096545 File Offset: 0x00094745
		public IEnumerable<CharacterObject> Troops
		{
			get
			{
				foreach (FlattenedTroopRosterElement flattenedTroopRosterElement in this._elementDictionary.Values)
				{
					yield return flattenedTroopRosterElement.Troop;
				}
				Dictionary<UniqueTroopDescriptor, FlattenedTroopRosterElement>.ValueCollection.Enumerator enumerator = default(Dictionary<UniqueTroopDescriptor, FlattenedTroopRosterElement>.ValueCollection.Enumerator);
				yield break;
				yield break;
			}
		}

		// Token: 0x0600236C RID: 9068 RVA: 0x00096555 File Offset: 0x00094755
		public void Clear()
		{
			this._elementDictionary.Clear();
		}

		// Token: 0x0600236D RID: 9069 RVA: 0x00096564 File Offset: 0x00094764
		public ICollection<FlattenedTroopRosterElement> RemoveIf(Predicate<FlattenedTroopRosterElement> match)
		{
			List<FlattenedTroopRosterElement> list = new List<FlattenedTroopRosterElement>();
			foreach (KeyValuePair<UniqueTroopDescriptor, FlattenedTroopRosterElement> keyValuePair in this._elementDictionary)
			{
				if (match(keyValuePair.Value))
				{
					list.Add(keyValuePair.Value);
				}
			}
			foreach (FlattenedTroopRosterElement flattenedTroopRosterElement in list)
			{
				this._elementDictionary.Remove(flattenedTroopRosterElement.Descriptor);
			}
			return list;
		}

		// Token: 0x0600236E RID: 9070 RVA: 0x00096620 File Offset: 0x00094820
		public UniqueTroopDescriptor FindIndexOfCharacter(CharacterObject character)
		{
			foreach (KeyValuePair<UniqueTroopDescriptor, FlattenedTroopRosterElement> keyValuePair in this._elementDictionary)
			{
				if (keyValuePair.Value.Troop == character)
				{
					return keyValuePair.Value.Descriptor;
				}
			}
			return UniqueTroopDescriptor.Invalid;
		}

		// Token: 0x0600236F RID: 9071 RVA: 0x00096698 File Offset: 0x00094898
		public IEnumerator<FlattenedTroopRosterElement> GetEnumerator()
		{
			foreach (FlattenedTroopRosterElement flattenedTroopRosterElement in this._elementDictionary.Values)
			{
				yield return flattenedTroopRosterElement;
			}
			Dictionary<UniqueTroopDescriptor, FlattenedTroopRosterElement>.ValueCollection.Enumerator enumerator = default(Dictionary<UniqueTroopDescriptor, FlattenedTroopRosterElement>.ValueCollection.Enumerator);
			yield break;
			yield break;
		}

		// Token: 0x06002370 RID: 9072 RVA: 0x000966A7 File Offset: 0x000948A7
		IEnumerator IEnumerable.GetEnumerator()
		{
			return this.GetEnumerator();
		}

		// Token: 0x06002371 RID: 9073 RVA: 0x000966B0 File Offset: 0x000948B0
		public void OnTroopKilled(UniqueTroopDescriptor troopSeed)
		{
			FlattenedTroopRosterElement flattenedTroopRosterElement = this._elementDictionary[troopSeed];
			this._elementDictionary[troopSeed] = new FlattenedTroopRosterElement(flattenedTroopRosterElement.Troop, RosterTroopState.Killed, 0, flattenedTroopRosterElement.Descriptor, 0);
		}

		// Token: 0x06002372 RID: 9074 RVA: 0x000966EC File Offset: 0x000948EC
		public void OnTroopWounded(UniqueTroopDescriptor troopSeed)
		{
			FlattenedTroopRosterElement flattenedTroopRosterElement = this._elementDictionary[troopSeed];
			this._elementDictionary[troopSeed] = new FlattenedTroopRosterElement(flattenedTroopRosterElement.Troop, RosterTroopState.WoundedInThisBattle, flattenedTroopRosterElement.Xp, flattenedTroopRosterElement.Descriptor, flattenedTroopRosterElement.XpGained);
		}

		// Token: 0x06002373 RID: 9075 RVA: 0x00096734 File Offset: 0x00094934
		public void OnTroopRouted(UniqueTroopDescriptor troopSeed)
		{
			FlattenedTroopRosterElement flattenedTroopRosterElement = this._elementDictionary[troopSeed];
			this._elementDictionary[troopSeed] = new FlattenedTroopRosterElement(flattenedTroopRosterElement.Troop, RosterTroopState.Routed, flattenedTroopRosterElement.Xp, flattenedTroopRosterElement.Descriptor, 0);
		}

		// Token: 0x06002374 RID: 9076 RVA: 0x00096778 File Offset: 0x00094978
		public int OnTroopGainXp(UniqueTroopDescriptor troopSeed, int xpAmount)
		{
			FlattenedTroopRosterElement flattenedTroopRosterElement = this._elementDictionary[troopSeed];
			int num = flattenedTroopRosterElement.XpGained + xpAmount;
			int num2 = num - flattenedTroopRosterElement.XpGained;
			if (num2 != 0)
			{
				this._elementDictionary[troopSeed] = new FlattenedTroopRosterElement(flattenedTroopRosterElement.Troop, flattenedTroopRosterElement.State, flattenedTroopRosterElement.Xp, flattenedTroopRosterElement.Descriptor, num);
			}
			return num2;
		}

		// Token: 0x04000AC1 RID: 2753
		[SaveableField(1)]
		private readonly Dictionary<UniqueTroopDescriptor, FlattenedTroopRosterElement> _elementDictionary;
	}
}
