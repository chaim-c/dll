using System;
using System.Collections.Generic;
using System.Xml;
using TaleWorlds.Library;
using TaleWorlds.ObjectSystem;
using TaleWorlds.SaveSystem;

namespace TaleWorlds.Core
{
	// Token: 0x02000035 RID: 53
	public class PropertyOwner<T> : MBObjectBase where T : MBObjectBase
	{
		// Token: 0x060003FD RID: 1021 RVA: 0x0000F43B File Offset: 0x0000D63B
		protected override void AutoGeneratedInstanceCollectObjects(List<object> collectedObjects)
		{
			base.AutoGeneratedInstanceCollectObjects(collectedObjects);
			collectedObjects.Add(this._attributes);
		}

		// Token: 0x060003FE RID: 1022 RVA: 0x0000F450 File Offset: 0x0000D650
		public PropertyOwner()
		{
			this._attributes = new Dictionary<T, int>();
		}

		// Token: 0x060003FF RID: 1023 RVA: 0x0000F463 File Offset: 0x0000D663
		public PropertyOwner(PropertyOwner<T> propertyOwner)
		{
			this._attributes = new Dictionary<T, int>(propertyOwner._attributes);
		}

		// Token: 0x06000400 RID: 1024 RVA: 0x0000F47C File Offset: 0x0000D67C
		public void SetPropertyValue(T attribute, int value)
		{
			if (value != 0)
			{
				this._attributes[attribute] = value;
				return;
			}
			if (this.HasProperty(attribute))
			{
				this._attributes.Remove(attribute);
			}
		}

		// Token: 0x06000401 RID: 1025 RVA: 0x0000F4A8 File Offset: 0x0000D6A8
		public int GetPropertyValue(T attribute)
		{
			if (attribute == null)
			{
				Debug.FailedAssert("attribute in GetPropertyValue can not be null!", "C:\\Develop\\MB3\\Source\\Bannerlord\\TaleWorlds.Core\\PropertyOwner.cs", "GetPropertyValue", 52);
				return 0;
			}
			int result;
			if (!this._attributes.TryGetValue(attribute, out result))
			{
				return 0;
			}
			return result;
		}

		// Token: 0x06000402 RID: 1026 RVA: 0x0000F4E8 File Offset: 0x0000D6E8
		public bool HasProperty(T attribute)
		{
			return this._attributes.ContainsKey(attribute);
		}

		// Token: 0x06000403 RID: 1027 RVA: 0x0000F4F6 File Offset: 0x0000D6F6
		public void ClearAllProperty()
		{
			this._attributes.Clear();
		}

		// Token: 0x06000404 RID: 1028 RVA: 0x0000F504 File Offset: 0x0000D704
		public void Serialize(XmlWriter writer)
		{
			writer.WriteStartElement("attributes");
			foreach (KeyValuePair<T, int> keyValuePair in this._attributes)
			{
				writer.WriteStartElement("attribute");
				writer.WriteAttributeString("id", keyValuePair.Key.StringId);
				writer.WriteAttributeString("value", keyValuePair.Value.ToString());
				writer.WriteEndElement();
			}
			writer.WriteEndElement();
		}

		// Token: 0x06000405 RID: 1029 RVA: 0x0000F5A8 File Offset: 0x0000D7A8
		public override void Deserialize(MBObjectManager objectManager, XmlNode node)
		{
			this.Initialize();
			foreach (object obj in node.ChildNodes)
			{
				XmlNode xmlNode = (XmlNode)obj;
				if (xmlNode.Name == "attributes")
				{
					foreach (object obj2 in xmlNode.ChildNodes)
					{
						XmlNode xmlNode2 = (XmlNode)obj2;
						if (xmlNode2.Name == "attribute")
						{
							string innerText = xmlNode2.Attributes["id"].InnerText;
							if (innerText.Substring(0, innerText.IndexOf('.')).Equals("Attrib"))
							{
								T attribute = objectManager.ReadObjectReferenceFromXml("id", typeof(T), xmlNode2) as T;
								int value = Convert.ToInt32(xmlNode2.Attributes["value"].Value);
								this.SetPropertyValue(attribute, value);
							}
						}
					}
				}
			}
		}

		// Token: 0x0400020E RID: 526
		[SaveableField(10)]
		protected readonly Dictionary<T, int> _attributes;
	}
}
