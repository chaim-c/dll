using System;
using System.Collections.Generic;
using System.Xml;
using TaleWorlds.Library;
using TaleWorlds.ObjectSystem;
using TaleWorlds.SaveSystem;

namespace TaleWorlds.Core
{
	// Token: 0x02000036 RID: 54
	public class PropertyOwnerF<T> : MBObjectBase where T : MBObjectBase
	{
		// Token: 0x06000406 RID: 1030 RVA: 0x0000F6F8 File Offset: 0x0000D8F8
		protected override void AutoGeneratedInstanceCollectObjects(List<object> collectedObjects)
		{
			base.AutoGeneratedInstanceCollectObjects(collectedObjects);
			collectedObjects.Add(this._attributes);
		}

		// Token: 0x06000407 RID: 1031 RVA: 0x0000F70D File Offset: 0x0000D90D
		public PropertyOwnerF()
		{
			this._attributes = new Dictionary<T, float>();
		}

		// Token: 0x06000408 RID: 1032 RVA: 0x0000F720 File Offset: 0x0000D920
		public PropertyOwnerF(PropertyOwnerF<T> propertyOwner)
		{
			this._attributes = new Dictionary<T, float>(propertyOwner._attributes);
		}

		// Token: 0x06000409 RID: 1033 RVA: 0x0000F739 File Offset: 0x0000D939
		public void SetPropertyValue(T attribute, float value)
		{
			if (!value.ApproximatelyEqualsTo(0f, 1E-05f))
			{
				this._attributes[attribute] = value;
				return;
			}
			if (this.HasProperty(attribute))
			{
				this._attributes.Remove(attribute);
			}
		}

		// Token: 0x0600040A RID: 1034 RVA: 0x0000F774 File Offset: 0x0000D974
		public float GetPropertyValue(T attribute)
		{
			if (attribute == null)
			{
				Debug.FailedAssert("attribute in GetPropertyValue can not be null!", "C:\\Develop\\MB3\\Source\\Bannerlord\\TaleWorlds.Core\\PropertyOwner.cs", "GetPropertyValue", 146);
				return 0f;
			}
			float result;
			if (!this._attributes.TryGetValue(attribute, out result))
			{
				return 0f;
			}
			return result;
		}

		// Token: 0x0600040B RID: 1035 RVA: 0x0000F7BF File Offset: 0x0000D9BF
		public bool HasProperty(T attribute)
		{
			return this._attributes.ContainsKey(attribute);
		}

		// Token: 0x0600040C RID: 1036 RVA: 0x0000F7CD File Offset: 0x0000D9CD
		public void ClearAllProperty()
		{
			this._attributes.Clear();
		}

		// Token: 0x0600040D RID: 1037 RVA: 0x0000F7DC File Offset: 0x0000D9DC
		public void Serialize(XmlWriter writer)
		{
			writer.WriteStartElement("attributes");
			foreach (KeyValuePair<T, float> keyValuePair in this._attributes)
			{
				writer.WriteStartElement("attribute");
				writer.WriteAttributeString("id", keyValuePair.Key.StringId);
				writer.WriteAttributeString("value", keyValuePair.Value.ToString());
				writer.WriteEndElement();
			}
			writer.WriteEndElement();
		}

		// Token: 0x0600040E RID: 1038 RVA: 0x0000F880 File Offset: 0x0000DA80
		public override void Deserialize(MBObjectManager objectManager, XmlNode node)
		{
			this.Initialize();
			foreach (object obj in node.ChildNodes)
			{
				XmlNode xmlNode = (XmlNode)obj;
				if (xmlNode.Name == "attributes")
				{
					foreach (object obj2 in xmlNode.ChildNodes)
					{
						XmlNode xmlNode2 = (XmlNode)obj2;
						if (xmlNode2.Name == "attribute")
						{
							string innerText = xmlNode2.Attributes["id"].InnerText;
							if (innerText.Substring(0, innerText.IndexOf('.')).Equals("Attrib"))
							{
								T attribute = objectManager.ReadObjectReferenceFromXml("id", typeof(T), xmlNode2) as T;
								int num = Convert.ToInt32(xmlNode2.Attributes["value"].Value);
								this.SetPropertyValue(attribute, (float)num);
							}
						}
					}
				}
			}
		}

		// Token: 0x0400020F RID: 527
		[SaveableField(10)]
		protected Dictionary<T, float> _attributes;
	}
}
